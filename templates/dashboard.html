<!DOCTYPE html>
<html lang="{{ get_locale() }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ _('AutoNeura AI - Dashboard') }}</title>
    <style>
        body, html { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; height: 100%; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; background: white; padding: 10px 40px; border-bottom: 1px solid #ddd; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .user-info span { margin-right: 20px; color: #495057; }
        .recharge-btn { background: #007bff; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: 600; }
        .container { display: flex; height: calc(100% - 61px); }
        .left-panel { flex: 0 0 450px; background-color: #ffffff; padding: 30px; display: flex; flex-direction: column; border-right: 1px solid #ddd; }
        .right-panel { flex-grow: 1; background-color: #f8f9fa; padding: 40px; overflow-y: auto; }
        h1, h2, h3, h4 { color: #1c1e21; margin-top: 0; }
        .chat-header h2 { font-size: 24px; }
        .chat-window { flex-grow: 1; border-radius: 8px; margin-top: 20px; display: flex; flex-direction: column; }
       .chat-messages { flex-grow: 1; overflow-y: auto; padding-right: 10px; }
        .chat-messages p { margin: 0; padding: 10px 15px; border-radius: 20px; max-width: 85%; word-wrap: break-word; line-height: 1.5; font-size: 15px;}
        .msg-user { background-color: #007bff; color: white; align-self: flex-end; margin-left: auto; }
        .msg-assistant { background-color: #e9ecef; color: #333; align-self: flex-start; }
        .chat-input { display: flex; border-top: 1px solid #ddd; padding-top: 15px; margin-top: 15px; }
        .chat-input input { flex-grow: 1; border: 1px solid #ccc; border-radius: 20px; padding: 10px 15px; font-size: 16px; outline: none; margin-right: 10px;}
        .chat-input button { border: none; background: #007bff; color: white; padding: 10px 20px; cursor: pointer; font-size: 16px; border-radius: 20px; }
        .tab-nav { display: flex; border-bottom: 1px solid #ddd; margin-bottom: 30px; }
        .tab-nav button { background: none; border: none; padding: 15px 20px; cursor: pointer; font-size: 16px; color: #606770; border-bottom: 3px solid transparent; }
        .tab-nav button.active { color: #007bff; border-bottom-color: #007bff; font-weight: 600; }
        .form-section { margin-bottom: 25px; }
        .form-section label { display: block; margin-bottom: 8px; font-weight: 600; color: #495057; }
        .form-section input, textarea { width: 100%; padding: 12px; border: 1px solid #ced4da; border-radius: 6px; box-sizing: border-box; font-size: 16px; }
        .cta-button { background-color: #28a745; color: white; padding: 15px 25px; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 20px;}
        .checkbox-group { display: flex; align-items: center; margin-bottom: 10px; }
        .checkbox-group label { font-weight: normal; margin-left: 8px; }
        .checkbox-group input { width: auto; }
        textarea { resize: none; height: 150px; }
        small { color: #6c757d; font-size: 12px; }
        .campaign-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; background-color: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .campaign-table th, .campaign-table td { border: 1px solid #ddd; padding: 12px 15px; text-align: left; }
        .campaign-table thead th { background-color: #f8f9fa; font-weight: 600; color: #495057; }
        .campaign-table tbody tr:hover { background-color: #e9ecef; cursor: pointer; }
        .plans-container { display: flex; gap: 20px; margin-bottom: 30px; }
        .plan-card { flex: 1; border: 2px solid #ddd; border-radius: 8px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.2s ease-in-out; }
        .plan-card.selected { border-color: #007bff; box-shadow: 0 0 10px rgba(0, 123, 255, 0.5); transform: translateY(-5px); }
        .plan-card h4 { margin: 0 0 10px 0; }
        .plan-card .price { font-size: 24px; font-weight: bold; margin: 10px 0; }
        @media (max-width: 900px) { .container { flex-direction: column; overflow: auto; } .left-panel { flex-basis: auto; min-height: 400px; } }
    </style>
</head>
<body>
    <div class="top-bar">
        <div class="logo"><h2>AutoNeura AI</h2></div>
        <div class="user-info">
            <span>{{ _('Bienvenido, Moises') }}</span>
            <span><strong>{{ _('Saldo:') }}</strong> $0.00</span>
            <button class="recharge-btn">{{ _('+ Recargar Saldo') }}</button>
        </div>
    </div>
    <div class="container">
        <div class="left-panel">
            <div class="chat-header">
                <h2>Inteligencia Artificial AutoNeura</h2>
            </div>
            <div class="chat-window">
                <div class="chat-messages" id="chat-messages">
                    <p class="msg-assistant">{{ _("¡Hola! Soy la Inteligencia Artificial AutoNeura, Estoy exclusivamente para generar ventas a través de todos los medios por internet  y trabajo 24/7 los 365 días del año nunca descanso busco analizo y proceso seguimientos a los prospectos de clientes de tus productos. No tendrás gastos por procesos si no por resultados, no pagas los miles de Prospectos que nosotros buscaremos en redes sociales como Facebook, Instagram, TIKTOK, X, etc. Como sucede con otros ADS que cobran por interacciones como: Clics, impresiones o vistas, no por ventas directas ni resultados garantizados. Te garantizo que soy tu mejor socio estratégico de Inteligencia Artificial aunque tú te quedes con toda la ganancia y yo me quedare con la satisfacción de haberte ayudado. Mi misión es simple: Te Conseguiré clientes utilizando técnicas Psicológicas y de Marketing que superan a todos los humanos juntos para encontrar prospectos, contactarlos, hacerle seguimientos hasta que le den comprar. Mi trabajo es tan efectivo que si, después de mi seguimiento avanzado, ningún prospecto hace clic en tu botón de compra: te daré un mes de mi servicio completamente gratis.") }}</p>
                    <p class="msg-assistant">{{ _("¿Tienes alguna pregunta?") }}</p>
                </div>
                <div class="chat-input">
                    <input type="text" id="user-input" placeholder="{{ _('Escribe tu pregunta...') }}">
                    <button id="send-btn">{{ _('Enviar') }}</button>
                </div>
            </div>
        </div>
        <div class="right-panel">
            <div class="tab-nav">
                <button class="tab-button active" data-tab="my-campaigns">{{ _('Mis Campañas') }}</button>
                <button class="tab-button" data-tab="campaign">{{ _('Crear Campaña') }}</button>
                <button class="tab-button" data-tab="data">{{ _('Datos del Producto') }}</button>
                <button class="tab-button" data-tab="billing">{{ _('Facturación') }}</button>
            </div>
            <div class="tab-content" id="my-campaigns">
                <h2>{{ _('Mis Campañas Activas y Pasadas') }}</h2>
                <table class="campaign-table">
                    <thead>
                        <tr>
                            <th>{{ _('Nombre de la Campaña') }}</th>
                            <th>{{ _('Fecha') }}</th>
                            <th>{{ _('Estado') }}</th>
                            <th>{{ _('Prospectos Encontrados') }}</th>
                            <th>{{ _('Leads Calificados') }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td>Búsqueda de Spas en Medellín</td><td>13/10/2025</td><td>Completada ✅</td><td>152</td><td>89</td></tr>
                        <tr><td>Restaurantes Italianos (Miami)</td><td>12/10/2025</td><td>Analizando ⚙️</td><td>100</td><td>45</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="tab-content" id="campaign" style="display:none;">
                <h2>{{ _('Configurar Campaña de Prospección') }}</h2>
                <div class="form-section">
                    <label>{{ _('1. Selecciona un Plan') }}</label>
                    <div class="plans-container">
                        <div class="plan-card" data-plan="arrancador"><h4>{{ _('El Arrancador') }}</h4><div class="price">$149<span>/mes</span></div><small>4 prospectos/día</small></div>
                        <div class="plan-card" data-plan="profesional"><h4>{{ _('El Profesional') }}</h4><div class="price">$399<span>/mes</span></div><small>15 prospectos/día</small></div>
                        <div class="plan-card" data-plan="dominador"><h4>{{ _('El Dominador') }}</h4><div class="price">$999<span>/mes</span></div><small>50 prospectos/día</small></div>
                    </div>
                </div>
                <div class="form-section">
                    <label for="prospects-per-day">{{ _('2. O personaliza la cantidad de Prospectos por Día') }}</label>
                    <input type="number" id="prospects-per-day" value="4" min="4">
                </div>
                <div class="form-section">
                    <label>{{ _('3. Define tu Campaña') }}</label>
                    <label for="campaign-name" style="margin-top:10px;">{{ _('Nombre de la Campaña') }}</label>
                    <input type="text" id="campaign-name" placeholder="{{ _('Ej: Búsqueda de Restaurantes en Miami') }}">
                    <label for="product-service" style="margin-top:15px;">{{ _('¿Qué vendes?') }}</label>
                    <input type="text" id="product-service" placeholder="{{ _('Ej: Software para restaurantes') }}">
                    <label for="target-audience" style="margin-top: 15px;">{{ _('¿A quién va dirigido?') }}</label>
                    <input type="text" id="target-audience" placeholder="{{ _('Ej: Restaurantes italianos, Ferreterías') }}">
                </div>
                <div class="form-section" style="background-color: #e9ecef; padding: 20px; border-radius: 8px;">
                    <h4>{{ _('Resumen Final') }}</h4>
                    <p>Plan Seleccionado: <strong id="selected-plan">El Arrancador</strong></p>
                    <p>Prospectos por día: <strong id="daily-prospects">4</strong></p>
                    <p>Costo Mensual Final: <strong id="total-cost">$149.00</strong></p>
                </div>
                <button class="cta-button">{{ _('Lanzar Campaña') }}</button>
            </div>
            <div class="tab-content" id="data" style="display:none;">
                <h2>{{ _('Información del Producto y Contacto') }}</h2>
                <div class="form-section"><label>{{ _('Tipo de Producto') }}</label><div class="checkbox-group"><input type="checkbox" id="tangible"><label for="tangible">{{ _('Tangible') }}</label></div><div class="checkbox-group"><input type="checkbox" id="intangible"><label for="intangible">{{ _('Intangible') }}</label></div></div>
                <div class="form-section"><label for="product-description">{{ _('Descripción del Producto/Servicio') }}</label><textarea id="product-description" maxlength="1000" placeholder="{{ _('Describe qué vendes...') }}"></textarea><small id="char-count">1000 caracteres restantes</small></div>
                <div class="form-section"><label for="contact-whatsapp">{{ _('Número de WhatsApp') }}</label><input type="text" id="contact-whatsapp"></div>
                <div class="form-section"><label for="purchase-link">{{ _('Enlace de Venta') }}</label><input type="text" id="purchase-link"></div>
                <button class="cta-button">{{ _('Guardar Datos') }}</button>
            </div>
            <div class="tab-content" id="billing" style="display:none;">
                <h2>{{ _('Mi Saldo y Facturación') }}</h2>
                <p>Saldo Actual: <strong>$0.00</strong></p>
                <button class="cta-button" style="background-color:#007bff;">{{ _('+ Recargar Saldo') }}</button>
            </div>
        </div>
    </div>
  
   <script>
document.addEventListener('DOMContentLoaded', function() {
    // --- MÓDULO DE NAVEGACIÓN POR PESTAÑAS ---
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');
    function switchTab(tabId) {
        if (!tabButtons.length || !tabContents.length) return;
        tabButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.tab === tabId));
        tabContents.forEach(content => content.style.display = content.id === tabId ? 'block' : 'none');
    }
    tabButtons.forEach(button => button.addEventListener('click', () => switchTab(button.dataset.tab)));

    // --- MÓDULO DE PLANES Y COSTOS ---
    const planCards = document.querySelectorAll('.plan-card');
    const prospectsInput = document.getElementById('prospects-per-day');
    const selectedPlanEl = document.getElementById('selected-plan');
    const dailyProspectsEl = document.getElementById('daily-prospects');
    const totalCostEl = document.getElementById('total-cost');
    const plans = { arrancador: { name: 'El Arrancador', basePrice: 149, baseProspects: 4, pricePerExtra: 30 }, profesional: { name: 'El Profesional', basePrice: 399, baseProspects: 15, pricePerExtra: 27 }, dominador: { name: 'El Dominador', basePrice: 999, baseProspects: 50, pricePerExtra: 20 } };
    let currentPlanKey = 'arrancador';
    function updateCosts() {
        if (!prospectsInput) return;
        let dailyCount = parseInt(prospectsInput.value) || 4;
        if (dailyCount < 4) { dailyCount = 4; prospectsInput.value = 4; }
        if (dailyCount >= 4 && dailyCount < 15) currentPlanKey = 'arrancador';
        else if (dailyCount >= 15 && dailyCount < 50) currentPlanKey = 'profesional';
        else currentPlanKey = 'dominador';
        const plan = plans[currentPlanKey];
        const extraProspects = dailyCount - plan.baseProspects;
        const finalCost = plan.basePrice + (extraProspects > 0 ? extraProspects * plan.pricePerExtra : 0);
        planCards.forEach(card => card.classList.toggle('selected', card.dataset.plan === currentPlanKey));
        if(selectedPlanEl) selectedPlanEl.textContent = plan.name;
        if(dailyProspectsEl) dailyProspectsEl.textContent = dailyCount;
        if(totalCostEl) totalCostEl.textContent = `$${finalCost.toFixed(2)}`;
    }
    if (prospectsInput) prospectsInput.addEventListener('input', updateCosts);
    planCards.forEach(card => {
        card.addEventListener('click', () => {
            const planKey = card.dataset.plan;
            if (prospectsInput) prospectsInput.value = plans[planKey].baseProspects;
            updateCosts();
        });
    });
    if (prospectsInput) updateCosts();

    // --- CÓDIGO PARA CONTADOR DE CARACTERES ---
    const descriptionTextarea = document.getElementById('descripcion_producto');
    const charCountEl = document.getElementById('char-count');
    if (descriptionTextarea) {
        descriptionTextarea.addEventListener('input', () => {
            const remaining = 1000 - descriptionTextarea.value.length;
            if(charCountEl) charCountEl.textContent = `${remaining} caracteres restantes`;
        });
    }

    // --- CÓDIGO DEL CHAT MEJORADO ---
    const chatForm = document.getElementById('chat-form');
    const userInput = document.getElementById('user-input');
    const chatMessages = document.getElementById('chat-messages');
    function addMessage(text, sender) {
        if(!chatMessages) return;
        const p = document.createElement('p');
        p.textContent = text;
        p.className = sender === 'user' ? 'msg-user' : 'msg-assistant';
        chatMessages.appendChild(p);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    async function handleSendMessage() {
        if (!userInput) return;
        const message = userInput.value.trim();
        if (!message) return;
        addMessage(message, 'user');
        userInput.value = '';
        try {
            const response = await fetch('/chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ message: message })
            });
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();
            if (data.error) { addMessage(`Error: ${data.error}`, 'assistant'); } 
            else { addMessage(data.response, 'assistant'); }
        } catch (error) {
            console.error("Error en la función fetch del chat:", error);
            addMessage('Lo siento, ocurrió un error de conexión.', 'assistant');
        }
    }
    if (chatForm) {
        chatForm.addEventListener('submit', function(event) {
            event.preventDefault();
            handleSendMessage();
        });
    }

    // --- CÓDIGO DEL "ESPÍA INTELIGENTE" ---
  const lanzarBtn = document.getElementById('lanzar-campana-btn');
            if (lanzarBtn) {
                lanzarBtn.addEventListener('click', function(event) {
                    event.preventDefault(); 
                    clearAllErrors();
                    const fieldsToValidate = [
                        { id: 'nombre_campana', tab: 'campaign', message: 'Por favor, dale un nombre a tu campaña.' },
                        { id: 'que_vendes', tab: 'campaign', message: 'Por favor, describe qué vendes.' },
                        { id: 'a_quien_va_dirigido', tab: 'campaign', message: 'Por favor, especifica a quién va dirigido.' },
                        { id: 'descripcion_producto', tab: 'data', message: 'La descripción del producto es necesaria.' },
                        { id: 'numero_whatsapp', tab: 'data', message: 'Necesitamos un número de WhatsApp de contacto.' },
                        { id: 'enlace_venta', tab: 'data', message: 'El enlace de venta es crucial para el cierre.' }
                    ];
                    let firstErrorField = null;
                    for (const field of fieldsToValidate) {
                        const element = document.getElementById(field.id);
                        if (!element || !element.value.trim()) {
                            if(element) showError(element, field.message);
                            if (!firstErrorField) { firstErrorField = { element, tab: field.tab }; }
                        }
                    }
                    const tangible = document.getElementById('tipo_producto_tangible');
                    const intangible = document.getElementById('tipo_producto_intangible');
                    if (tangible && intangible && !tangible.checked && !intangible.checked) {
                         if (!firstErrorField) { firstErrorField = { element: tangible, tab: 'data' }; }
                        showError(tangible.parentElement.parentElement, 'Debes seleccionar al menos un tipo de producto.');
                    }
                    if (firstErrorField) {
                        switchTab(firstErrorField.tab);
                        setTimeout(() => {
                           if(firstErrorField.element) {
                               firstErrorField.element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                               firstErrorField.element.focus();
                           }
                        }, 100);
                    } else {
                        // ¡¡¡CÓDIGO CORREGIDO!!! AHORA SÍ RECOGE TODO.
                        const campaignData = {
                            nombre_campana: document.getElementById('nombre_campana').value,
                            que_vendes: document.getElementById('que_vendes').value,
                            a_quien_va_dirigido: document.getElementById('a_quien_va_dirigido').value,
                            prospectos_por_dia: document.getElementById('prospects-per-day').value,
                            tipo_producto_tangible: document.getElementById('tipo_producto_tangible').checked,
                            tipo_producto_intangible: document.getElementById('tipo_producto_intangible').checked,
                            descripcion_producto: document.getElementById('descripcion_producto').value,
                            numero_whatsapp: document.getElementById('numero_whatsapp').value,
                            enlace_venta: document.getElementById('enlace_venta').value
                        };

                        fetch('/crear-campana', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(campaignData)
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                alert('¡Éxito! El Orquestador ha recibido la campaña: ' + data.message);
                                switchTab('my-campaigns');
                            } else {
                                alert('Error del Servidor: ' + data.message);
                            }
                        })
                        .catch(error => {
                            console.error('Error de red al crear campaña:', error);
                            alert('Error de conexión al intentar crear la campaña.');
                        });
                    }
                });
            }
    // --- CÓDIGO PROFESIONAL PARA WHATSAPP ---
    const phoneInputField = document.querySelector("#numero_whatsapp");
    if (phoneInputField) {
        const phoneInput = window.intlTelInput(phoneInputField, {
            initialCountry: "auto",
            geoIpLookup: function(callback) {
                fetch("https://ipapi.co/json").then(res => res.json()).then(data => callback(data.country_code)).catch(() => callback("us"));
            },
            utilsScript: "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js",
        });
    }

    // --- CÓDIGO RESPONSIVO ---
    const mobileChatToggle = document.getElementById('mobile-chat-toggle');
    const leftPanel = document.getElementById('left-panel');
    if (mobileChatToggle && leftPanel) {
        mobileChatToggle.addEventListener('click', () => {
            leftPanel.classList.toggle('visible');
        });
    }

    // --- LÍNEA DE INICIALIZACIÓN ---
    switchTab('my-campaigns');
});
   </script>
</body>
</html>
